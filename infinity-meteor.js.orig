// Performance monitoring : https://kadira.io/
// watching DDP msgs : https://github.com/arunoda/meteor-ddp-analyzer
// DDP: Distributed Data Protocol: 
//   https://github.com/meteor/meteor/blob/devel/packages/ddp/DDP.md
//   https://meteorhacks.com/introduction-to-ddp.html

var AuthoritiesDB = new Mongo.Collection("authorities");

if (Meteor.isClient) {
  // counter starts at 0
  Session.setDefault('counter', 0);

  Template.hello.helpers({
    counter: function () {
      return Session.get('counter');
    }
  });

  Template.hello.events({
    'click button': function () {
      // increment the counter when button is clicked
      Session.set('counter', Session.get('counter') + 1);
    }
  });
}

if (Meteor.isServer) {
  var log = new Logger('app');
  Logger.setLevel('info');
  Logger.setLevel('app', 'debug');

  Meteor.startup(function () {
    // code to run on server at startup

    // example method defn
    Meteor.methods({
      checkTwitter: function () {
          // this.unblock();
          return Meteor.http.call("GET", "http://search.twitter.com/search.json?q=perkytweets");
      }
    });

    // var requestAuthorities = HTTP.get(Meteor.absoluteUrl("/")).data;
    // var requestAuthorities = {};
    // requestAuthorities = JSON.parse(Assets.getText("request-authorities.json"));

    var apiUrlAuthorities = "http://api.ratings.food.gov.uk/Authorities/basic";
    // var apiUrlAuthorities = "http://api.ratings.food.gov.uk/Authorities";

    var headers = {};
    headers['x-api-version'] = '2';
    headers['accept'] = 'application/json';
    headers['content-type'] = 'application/json';
    // headers['content-length'] = '3124';
    headers['Accept-Language'] = 'en-GB';

    // straight call
    HTTP.get(apiUrlAuthorities, { headers: headers },
          function (error, result) {
            if (!error) {
              // share the goods
              // Session.set("twizzled", true);
              log.info("Got authorities");
              // log.debug(JSON.stringify(result, null, 2));
              log.debug(result);


              // var tb = Observatory.getToolbox();
              // tb.info("got json back ", result);

            } else {
              log.error("getAuthorities failed with http err: "+ error);
              // log.error(JSON.stringify(result, null, 2));

            }
          });
  });

}
